<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>BloxOLite ‚Äî Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">

  <style>
    /* ----- EXACT UI STYLES FROM YOUR SCREENSHOT ----- */
    :root {
      --bg: #0d1117;
      --card-bg: #0f1720; /* slightly darker for panels */
      --panel-bg: rgba(15,23,32,0.6);
      --border: rgba(255,255,255,0.03);
      --accent: #6b63ff;
      --accent-strong: #8b84ff;
      --text: #dfe6ff;
      --muted: #9ca3af;
    }

    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%}
    body{
      font-family:"Inter",system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;
      background: linear-gradient(180deg,#0b0f14 0%, #0d1117 60%);
      color:var(--text);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      overflow-y:auto;
    }

    nav{
      height:64px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:0 40px;
      border-bottom:1px solid var(--border);
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0));
      position:sticky;
      top:0;
      z-index:30;
    }
    .logo{color:var(--accent);font-weight:700;font-size:20px}
    .nav-links{display:flex;gap:24px;align-items:center}
    .nav-links a{color:var(--muted);text-decoration:none;font-size:15px}
    .signout-btn{
      background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted);
      padding:8px 12px;border-radius:8px;font-size:14px;cursor:pointer;
    }

    main{
      max-width:1000px;
      margin:50px auto;
      padding:0 24px 80px;
    }

    h1{
      text-align:center;
      color:var(--accent);
      font-size:36px;
      margin-bottom:28px;
      text-shadow: 0 1px 0 rgba(0,0,0,0.6);
    }

    /* Panel container */
    .panel {
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.06));
      border-radius:12px;
      border:1px solid var(--border);
      padding:26px;
      margin:18px auto 28px;
      box-shadow: 0 6px 18px rgba(2,6,23,0.6);
    }

    /* Inputs match screenshot */
    .input, textarea, select {
      width:100%;
      background: rgba(0,0,0,0.35);
      border:1px solid rgba(255,255,255,0.03);
      color:var(--text);
      padding:12px 14px;
      border-radius:8px;
      outline:none;
      margin-bottom:14px;
      font-size:14px;
      resize:vertical;
    }
    textarea { min-height:120px; }

    .small-row { display:flex; gap:12px; align-items:center; }
    .small-row .input { flex:1 }

    .label-row { display:flex; align-items:center; gap:10px; margin:8px 0 14px; color:var(--muted) }
    .badge {
      display:inline-block;padding:6px 10px;border-radius:999px;font-weight:600;font-size:13px;
      background:linear-gradient(90deg, rgba(255,255,255,0.02), rgba(0,0,0,0.25));
      color:var(--text); border:1px solid rgba(255,255,255,0.02)
    }

    .actions { display:flex; gap:12px; margin-top:10px }
    .btn {
      background:var(--accent);
      color:white;padding:10px 18px;border-radius:10px;border:none;font-weight:600;cursor:pointer;
      box-shadow: 0 8px 22px rgba(107,99,255,0.12);
    }
    .btn.secondary { background:#2b3140;color:var(--text);border:1px solid rgba(255,255,255,0.03) }

    /* Announcement list area */
    .ann-list { margin-top:18px; display:flex; flex-direction:column; gap:14px; }
    .ann-card {
      background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.06));
      border-radius:10px; padding:14px 18px; border:1px solid rgba(255,255,255,0.02);
    }
    .ann-top { display:flex; justify-content:space-between; align-items:center; gap:12px; }
    .ann-title { color:var(--accent-strong); font-weight:700; }
    .ann-meta { color:var(--muted); font-size:13px; }

    .ann-tag { display:inline-block; padding:6px 10px; border-radius:999px; font-weight:700; font-size:13px; color:#fff; margin-left:8px; }

    .ann-image { width:100%; max-height:320px; object-fit:cover; border-radius:8px; margin-top:10px; }

    /* Collapsible logs section */
    .logs-toggle { display:flex; justify-content:flex-end; margin-top:8px; }
    .logs-panel { display:none; margin-top:12px; gap:12px; flex-direction:column; }
    .log-card { background: rgba(255,255,255,0.02); padding:12px;border-radius:8px;border:1px solid rgba(255,255,255,0.02); color:var(--muted) }

    /* responsive */
    @media (max-width:760px){
      nav{padding:0 16px}
      main{padding:0 16px}
      h1{font-size:28px}
    }
  </style>
</head>
<body>
  <nav>
    <div class="logo">BloxOLite</div>
    <div class="nav-links">
      <a href="index.html">Home</a>
      <a href="docs.html">Docs</a>
      <a href="dashboard.html">Dashboard</a>
      <button id="signOutBtn" class="signout-btn" style="display:none">Sign Out</button>
    </div>
  </nav>

  <main>
    <h1>Website Administrator Dashboard</h1>

    <!-- Login overlay (keeps the exact page UI; overlay hides when logged in) -->
    <div id="loginOverlay" class="panel" style="max-width:720px;margin:10px auto 26px;">
      <div style="display:flex;flex-direction:column;gap:12px">
        <div style="font-weight:700;color:var(--accent);font-size:18px">üîê Access Required</div>
        <input id="accessInput" class="input" type="password" placeholder="Enter Access Code">
        <div style="display:flex;gap:8px">
          <button id="verifyBtn" class="btn">Verify</button>
          <div style="flex:1"></div>
        </div>
        <div id="accessError" style="color:#f97373;font-size:13px;height:18px"></div>
      </div>
    </div>

    <!-- Announcement creation panel (UI preserved pixel-perfect) -->
    <div id="mainPanel" style="display:none;">
      <div class="panel" style="max-width:760px;margin:24px auto;">
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:6px">
          <div style="font-weight:800;color:var(--accent);font-size:18px">üì¢ Post New Announcement</div>
        </div>

        <input id="annTitle" class="input" placeholder="Announcement Title">
        <textarea id="annMessage" class="input" placeholder="Supports Markdown: **bold**, *italic*, [link](https://...), lists"></textarea>

        <input id="annTag" class="input" placeholder="Tag (e.g., Update, Alert, Info)">
        <div class="small-row" style="margin-bottom:8px">
          <input id="annColor" type="color" value="#6366f1" style="height:44px;border-radius:8px;padding:6px;border:1px solid rgba(255,255,255,0.03)">
          <input id="annImage" class="input" placeholder="Image URL (optional)" style="margin:0">
        </div>

        <div class="label-row">
          <label style="display:flex;align-items:center;gap:8px">
            <input id="annPinned" type="checkbox" style="width:16px;height:16px">
            <span style="color:var(--muted)">üìå Pin this announcement</span>
          </label>
        </div>

        <div class="actions">
          <button id="previewBtn" class="btn secondary">Preview</button>
          <button id="postAnnBtn" class="btn">Post Announcement</button>
          <div style="flex:1"></div>
          <div id="postStatus" style="color:var(--muted);align-self:center"></div>
        </div>

        <!-- Preview box (keeps location and spacing identical) -->
        <div id="previewBox" style="display:none;margin-top:18px;padding:14px;border-radius:10px;background:var(--panel-bg);border:1px solid var(--border)">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div id="previewTitle" style="font-weight:700;color:var(--accent-strong)"></div>
            <div id="previewTag" style="font-weight:700"></div>
          </div>
          <div id="previewMessage" style="margin-top:8px;color:var(--muted)"></div>
          <img id="previewImage" src="" alt="" style="display:none;margin-top:10px;border-radius:8px;max-width:100%">
        </div>
      </div>

      <!-- Announcements list -->
      <div class="panel" style="max-width:760px;margin:14px auto;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <div style="font-weight:800;color:var(--accent);font-size:18px">üì£ Live Announcements</div>
          <div style="color:var(--muted);font-size:13px">Pinned appear first</div>
        </div>

        <div id="annList" class="ann-list">
          <!-- populated by JS -->
          <div style="color:var(--muted)">Loading announcements‚Ä¶</div>
        </div>

        <!-- Logs toggle -->
        <div class="logs-toggle" style="margin-top:14px">
          <button id="toggleLogs" class="btn secondary">Show Recent Logs</button>
        </div>

        <!-- Logs panel (collapsed by default) -->
        <div id="logsPanel" class="logs-panel" style="display:flex;flex-direction:column;">
          <div id="logsList" style="margin-top:12px">
            <div style="color:var(--muted)">No logs yet.</div>
          </div>
        </div>
      </div>

      <!-- System status panel -->
      <div class="panel" style="max-width:760px;margin:14px auto;">
        <div style="font-weight:700;color:var(--accent);margin-bottom:8px">üß± System Status</div>
        <div style="color:#22c55e">‚úÖ All systems operational</div>
      </div>
    </div>
  </main>

  <footer style="text-align:center;padding:40px;color:var(--muted);border-top:1px solid rgba(255,255,255,0.02)">
    ¬© 2025 BloxOLite Dashboard
  </footer>

  <!-- Libraries -->
  <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@2.4.0/dist/purify.min.js"></script>

  <!-- Firebase SDKs (modular) -->
  <script type="module">
    AOS.init({duration:600,once:true});

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
    import {
      getFirestore, collection, addDoc, getDocs, query, orderBy, limit, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

    /* ========== CONFIG ========== */
    const firebaseConfig = {
      apiKey: "AIzaSyBZJa5yjFeCmAPOQOHUKCZpq_yEyCJtdPI",
      authDomain: "bloxolite.firebaseapp.com",
      projectId: "bloxolite",
      storageBucket: "bloxolite.firebasestorage.app",
      messagingSenderId: "261033706903",
      appId: "1:261033706903:web:241f50fbaf65209dfa30d2"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    /* ========== UI refs ========== */
    const loginOverlay = document.getElementById("loginOverlay");
    const mainPanel = document.getElementById("mainPanel");
    const signOutBtn = document.getElementById("signOutBtn");
    const verifyBtn = document.getElementById("verifyBtn");
    const accessInput = document.getElementById("accessInput");
    const accessError = document.getElementById("accessError");

    // Announcement refs
    const annTitle = document.getElementById("annTitle");
    const annMessage = document.getElementById("annMessage");
    const annTag = document.getElementById("annTag");
    const annColor = document.getElementById("annColor");
    const annImage = document.getElementById("annImage");
    const annPinned = document.getElementById("annPinned");
    const previewBtn = document.getElementById("previewBtn");
    const postAnnBtn = document.getElementById("postAnnBtn");
    const postStatus = document.getElementById("postStatus");
    const previewBox = document.getElementById("previewBox");
    const previewTitle = document.getElementById("previewTitle");
    const previewMessage = document.getElementById("previewMessage");
    const previewImage = document.getElementById("previewImage");
    const previewTag = document.getElementById("previewTag");

    const annList = document.getElementById("annList");

    // Logs
    const toggleLogsBtn = document.getElementById("toggleLogs");
    const logsPanel = document.getElementById("logsPanel");
    const logsList = document.getElementById("logsList");

    /* ========== ACCESS CONTROL ========== */
    // keep your existing hash (don't change style)
    const ACCESS_HASH = "-94374278";

    function computeHash(str){
      return Array.from(str).reduce((h,c)=>{h=(h<<5)-h+c.charCodeAt(0);return h&h},0).toString();
    }

    verifyBtn.addEventListener("click", () => {
      const value = accessInput.value || "";
      const h = computeHash(value);
      if (h === ACCESS_HASH) {
        localStorage.setItem("bloxoliteAccess", "true");
        accessError.textContent = "";
        showDashboard();
      } else {
        accessError.textContent = "Incorrect access code.";
      }
    });

    function showDashboard(){
      loginOverlay.style.display = "none";
      mainPanel.style.display = "block";
      signOutBtn.style.display = "inline-block";
      // load data
      loadAnnouncements().catch(console.error);
      // don't auto-load logs until user opens logs panel to avoid extra reads
    }

    // Auto-login if stored
    if (localStorage.getItem("bloxoliteAccess") === "true") {
      showDashboard();
    }

    // Sign out
    signOutBtn.addEventListener("click", () => {
      localStorage.removeItem("bloxoliteAccess");
      loginOverlay.style.display = "";
      mainPanel.style.display = "none";
      signOutBtn.style.display = "none";
      accessInput.value = "";
    });

    /* ========== ANNOUNCEMENT: preview & post ========== */
    function renderMarkdownToSafeHtml(md){
      try {
        const raw = marked.parse(md || "");
        // sanitize with DOMPurify global
        return DOMPurify.sanitize(raw, {ALLOWED_TAGS: ['b','i','em','strong','a','code','pre','ul','ol','li','p','br','span','h1','h2','h3'], ALLOWED_ATTR: ['href','target','style']});
      } catch(e){
        return DOMPurify.sanitize(String(md));
      }
    }

    previewBtn.addEventListener("click", () => {
      const title = annTitle.value || "No title";
      const md = annMessage.value || "";
      const tag = annTag.value || "";
      const color = annColor.value || "#6366f1";
      const img = annImage.value || "";

      previewTitle.textContent = title;
      previewTag.innerHTML = tag ? `<span class="ann-tag" style="background:${color}">#${tag}</span>` : "";
      previewMessage.innerHTML = renderMarkdownToSafeHtml(md);

      if (img) {
        previewImage.src = img;
        previewImage.style.display = "block";
      } else {
        previewImage.style.display = "none";
        previewImage.src = "";
      }

      previewBox.style.display = "block";
      // scroll to preview so user sees it (keeps UI behavior)
      previewBox.scrollIntoView({behavior:"smooth", block:"center"});
    });

    postAnnBtn.addEventListener("click", async () => {
      const title = annTitle.value.trim();
      const md = annMessage.value.trim();
      const tag = annTag.value.trim();
      const color = annColor.value;
      const img = annImage.value.trim();
      const pinned = !!annPinned.checked;

      if (!title || !md) {
        postStatus.style.color = "#f97373";
        postStatus.textContent = "Please fill title and message.";
        return;
      }

      postStatus.style.color = "var(--muted)";
      postStatus.textContent = "Posting‚Ä¶";

      try {
        await addDoc(collection(db, "announcements"), {
          title,
          message: md,
          tag: tag || null,
          color: color || null,
          image: img || null,
          pinned: pinned,
          date: (new Date()).toLocaleString(),
          createdAt: serverTimestamp()
        });

        postStatus.style.color = "#86efac";
        postStatus.textContent = "‚úÖ Posted!";
        // clear inputs (but keep color)
        annTitle.value = "";
        annMessage.value = "";
        annTag.value = "";
        annImage.value = "";
        annPinned.checked = false;
        previewBox.style.display = "none";

        // reload announcements (fresh)
        await loadAnnouncements();
      } catch (err) {
        console.error(err);
        postStatus.style.color = "#f97373";
        postStatus.textContent = "Failed to post.";
      }

      setTimeout(()=> postStatus.textContent = "", 2500);
    });

    /* ========== LOAD ANNOUNCEMENTS ========== */
    async function loadAnnouncements(){
      annList.innerHTML = `<div style="color:var(--muted)">Loading announcements‚Ä¶</div>`;
      try {
        // pinned first, then createdAt desc
        const q = query(collection(db, "announcements"), orderBy("pinned","desc"), orderBy("createdAt","desc"), limit(50));
        const snap = await getDocs(q);

        annList.innerHTML = "";
        if (snap.empty) {
          annList.innerHTML = `<div style="color:var(--muted)">No announcements yet.</div>`;
          return;
        }

        snap.forEach(doc => {
          const a = doc.data();
          const card = document.createElement("div");
          card.className = "ann-card";

          // title safe
          const safeTitle = DOMPurify.sanitize(String(a.title || "Update"), {ALLOWED_TAGS: [], ALLOWED_ATTR: []});

          // message rendered from markdown to safe HTML
          const msgHtml = renderMarkdownToSafeHtml(a.message || "");

          // tag badge
          let tagHTML = "";
          if (a.tag) {
            const color = a.color || "#6366f1";
            tagHTML = `<span class="ann-tag" style="background:${DOMPurify.sanitize(color)}">#${DOMPurify.sanitize(String(a.tag))}</span>`;
          }

          // image if present (sanitized URL)
          const imgHTML = a.image ? `<img class="ann-image" src="${DOMPurify.sanitize(a.image)}" alt="announcement image">` : "";

          // pinned icon
          const pinned = a.pinned ? "üìå " : "";

          // date
          const date = a.date ? DOMPurify.sanitize(String(a.date)) : "";

          card.innerHTML = `
            <div class="ann-top">
              <div>
                <div class="ann-title">${pinned}${safeTitle}${tagHTML}</div>
                <div class="ann-meta" style="margin-top:6px">${date}</div>
              </div>
            </div>
            <div style="margin-top:10px;color:var(--muted)">${msgHtml}</div>
            ${imgHTML}
          `;

          annList.appendChild(card);
        });
      } catch (e){
        console.error(e);
        annList.innerHTML = `<div style="color:#f97373">Failed to load announcements. Check Firestore/indexes.</div>`;
      }
    }

    /* ========== LOGS: toggle + load ========== */
    let logsVisible = false;
    toggleLogsBtn.addEventListener("click", async () => {
      logsVisible = !logsVisible;
      logsPanel.style.display = logsVisible ? "flex" : "none";
      toggleLogsBtn.textContent = logsVisible ? "Hide Recent Logs" : "Show Recent Logs";
      if (logsVisible) {
        await loadLogs();
      }
    });

    async function loadLogs(){
      logsList.innerHTML = `<div style="color:var(--muted)">Loading logs‚Ä¶</div>`;
      try {
        const q = query(collection(db, "kickLogs"), orderBy("time","desc"), limit(30));
        const snap = await getDocs(q);
        logsList.innerHTML = "";
        if (snap.empty) {
          logsList.innerHTML = `<div style="color:var(--muted)">No recent logs.</div>`;
          return;
        }
        snap.forEach(doc => {
          const d = doc.data();
          // d may have timestamp as string; sanitize
          const player = d.player || d.playerName || "Unknown";
          const reason = d.reason || "Unknown";
          const time = d.time || d.timestamp || d.timeString || "";
          const executor = d.executor || "System";

          const el = document.createElement("div");
          el.className = "log-card";
          el.innerHTML = `
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div style="font-weight:700;color:var(--accent-strong)">${DOMPurify.sanitize(String(player))}</div>
              <div style="color:var(--muted);font-size:13px">${DOMPurify.sanitize(String(time))}</div>
            </div>
            <div style="margin-top:6px;color:var(--muted)">
              <strong>Reason:</strong> ${DOMPurify.sanitize(String(reason))} ‚Ä¢ <strong>By:</strong> ${DOMPurify.sanitize(String(executor))}
            </div>
          `;
          logsList.appendChild(el);
        });
      } catch (err){
        console.error(err);
        logsList.innerHTML = `<div style="color:#f97373">Failed to load logs.</div>`;
      }
    }

    /* ========== INITIALS: nothing auto-loaded until login (keeps UI same) ========== */
    // (Announcements will load when user verifies successfully or if already logged in)
  </script>
</body>
</html>
